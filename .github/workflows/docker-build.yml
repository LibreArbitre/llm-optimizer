name: Docker Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: docker build -t llm-optimizer:test .
    
    - name: Test container startup
      run: |
        docker run -d -p 8080:80 --name test-container llm-optimizer:test
        sleep 10
        
    - name: Health check
      run: |
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Health check failed with HTTP code: $HTTP_CODE"
          docker logs test-container
          exit 1
        fi
        echo "Health check passed (HTTP 200)"
    
    - name: Verify PHP processing
      run: |
        CONTENT=$(curl -s http://localhost:8080 | grep -o "LLM Optimizer")
        if [ -z "$CONTENT" ]; then
          echo "PHP processing test failed"
          docker logs test-container
          exit 1
        fi
        echo "PHP processing test passed"
    
    - name: Check image size
      run: |
        SIZE=$(docker images llm-optimizer:test --format "{{.Size}}")
        echo "Image size: $SIZE"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop test-container || true
        docker rm test-container || true
